FROM golang:1.22-alpine AS builder

# 安装git
RUN apk add --no-cache git

WORKDIR /app

# 克隆源码
RUN git clone https://github.com/oficcejo/tdx-api.git .

# 显示文件结构用于调试
RUN ls -la

# 尝试编译，如果失败会显示错误信息
RUN if [ -f "web/main.go" ]; then \
        cd web && go build -o ../stock-web .; \
    elif [ -f "main.go" ]; then \
        go build -o stock-web .; \
    else \
        echo "错误：找不到main.go文件" && \
        find . -name "*.go" -type f | head -10 && \
        exit 1; \
    fi

# 运行阶段
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /app

COPY --from=builder /app/stock-web .

EXPOSE 8080

CMD ["./stock-web"]
