FROM golang:1.22-alpine AS builder

RUN apk add --no-cache git

WORKDIR /app

# 克隆并显示结构
RUN git clone https://github.com/oficcejo/tdx-api.git . && \
    echo "=== 显示文件结构 ===" && \
    find . -type f -name "*.go" && \
    echo "=== 显示目录结构 ===" && \
    ls -laR

# 尝试查找并编译
RUN find . -name "main.go" -type f | head -5 && \
    if find . -name "main.go" -type f | grep -q "."; then \
        MAIN_FILE=$(find . -name "main.go" -type f | head -1) && \
        MAIN_DIR=$(dirname "$MAIN_FILE") && \
        echo "在 $MAIN_DIR 找到 main.go" && \
        cd "$MAIN_DIR" && \
        go build -o /app/stock-web .; \
    else \
        echo "错误：没有找到main.go文件" && \
        exit 1; \
    fi

FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /app

COPY --from=builder /app/stock-web .

EXPOSE 8080

CMD ["./stock-web"]
