# TDX API 更新说明（2025-11-10）

## 1. 新增 / 调整接口

### 1.1 全量历史 K 线
- `GET /api/kline-all/tdx`：返回通达信原始（不复权）历史 K 线，支持全部周期，响应结构：
  ```json
  {
    "code": 0,
    "message": "success",
    "data": {
      "count": 1000,
      "list": [ ... ],
      "meta": {
        "source": "tdx",
        "type": "day",
        "batch_limit": 800,
        "notes": [
          "通达信单次底层请求最多返回 800 条数据，服务端已顺序拼接全量结果",
          "对于上市时间较长的标的，请预估调用耗时（通常 1-5 秒），客户端需自行设置超时与兜底策略",
          "若实测请求在超时阈值内成功返回数据，即视为成功调用，无需按预设超时上限计入统计"
        ]
      }
    }
  }
  ```
- `GET /api/kline-all/ths`：返回同花顺前复权日/周/月 K 线，响应结构与上方一致，`meta.source="ths"`。

> 兼容性提示：旧版脚本若按数组解析需改为读取 `data.list`。

### 1.2 历史成交与交易日接口
- `GET /api/trade-history/full`：新增 `start_date` / `end_date` / `include_today` 参数，支持按交易日批量拉取，响应：
  ```json
  {
    "code": 0,
    "message": "success",
    "data": {
      "code": "000001",
      "start_date": "2024-10-01",
      "end_date": "2024-10-08",
      "limit": 300,
      "count": 300,
      "truncated": false,
      "covered_dates": ["20241001", "..."],
      "list": [ ... ]
    }
  }
  ```
- `GET /api/workday/range`：在交易日日志为空时自动触发 `manager.Workday.Update()` 并返回 `list` 数组。原本返回纯列表的调用需改为读取 `data.list`。

### 1.3 分时数据
- `GET /api/minute`：不再自动回退其他日期，如指定日期无数据返回 `List: []`，留给调用方自行兜底。响应字段保留 `date`。

### 1.4 任务接口
- `POST /api/tasks/pull-kline` / `POST /api/tasks/pull-trade`：保持原行为，新测试脚本会在测试结束后自动取消任务。

## 2. 前端改进
- `web/static/app.js`：
  - `switchTab(evt, tabName)` 使用 `requestAnimationFrame + resize()` 解决图表仅显示在左侧的问题。
  - `displayMinute` 与 `displayKline` 初次渲染后立即调用 `resize()`。
- `web/static/index.html`：更新标签按钮为 `onclick="switchTab(event, 'kline')"` 等写法。

## 3. 测试脚本
- 新增 `scripts/run_api_checks.py`，覆盖所有公开接口并兼容新响应格式，运行示例：
  ```bash
  python scripts/run_api_checks.py
  ```
- 新增 `scripts/test_tdx_all_api.py`，运行示例：
  ```bash
  python -I scripts/test_tdx_all_api.py \
    --base-url http://127.0.0.1:8080 \
    --verbose \
    --output tmp/tdx_api_test_results.json
  ```

## 4. 验证建议
1. 访问 `http://localhost:8080/static/app.js`，确认 `switchTab(evt, tabName)` 逻辑存在。
2. 浏览器强制刷新/清缓存，确保加载新脚本。
3. 完整运行两套测试：
   - `python run_api_checks.py`
   - `python -I scripts/test_tdx_all_api.py ...`
4. 若进一步部署到容器环境，确认 `docker logs -f tdx-stock-web` 输出健康检查成功。

---

如需回溯旧版本，请在部署前备份数据库与静态资源；对旧客户端请同步升级解析逻辑。***

